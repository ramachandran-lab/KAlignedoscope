# *KAlignedoscope*: An interactive visualization tool for aligned clustering results from population structures analyses
-Powered by JavaScript D3-

***KAlignedoscope*** provides interactive visualizations for **aligned clustering results from population structure analysis** (e.g., [*Structure*](https://web.stanford.edu/group/pritchardlab/structure.html), [*ADMIXTURE*](https://github.com/NovembreLab/admixture), [*fastStructure*](https://rajanil.github.io/fastStructure)) that are aligned by **clustering alignment** methods (e.g., [*Clumppling*](https://github.com/PopGenClustering/Clumppling), [*Pong*](https://github.com/ramachandran-lab/pong)).

## Example interface
[This is a temporary placeholder. A snapshot of the interfact will be attached soon.]

## Terms
Here are some terminologies we use throughout this guide:
* Membership matrix: The clustering output matrix ($N$ rows by $K$ columns) for $N$ individuals and $K$ clusters. Each row represents an individual's memberships in all clusters, with row entries summing up to one. 
* Clustering mode: Distinct clustering solutions that are representative of all clustering runs.
  * major mode: The clustering mode which the largerst number of clustering runs align to.
  * minor mode: The clustering mode which fewer clustering runs align to.
* Structure plot: Visualization of the membership matrix in stacked bar charts. Each individual corresponds to a column in the plot, with its fraction memberships in clusters represented by stacked bars with distinct colors.
* Population label: The labels pre-assigned to individuals. In population genetics data, this is usually the population that each individual is sampled from, e.g., ``GBR`` for British and ``PUR`` for "Puerto Rican in Puerto Rico" in 1000 Genomes Project data.

## A summary of features

***KAlignedoscope*** aims to support user-interactivity and friendliness with aesthetic interface. Some important features include:
1. Reordering:
   * (if population label is provided for each individual) reorder population
   * reorder individuals by dominant cluster in a population
   * reorder clusters (update its vertical stacking order in the structure plot)
2. Highlight a cluster
3. Display of alignment quality between cluster modes with different K
4. Display of information of specific component through hovering tooltips.
5. Other customizable features: cluster name relabeling, cluster color picking, and title renaming. 

## Installation
### *Python* and dependencies
See [the tutorial of *Clummppling*](https://github.com/PopGenClustering/Clumppling) on how to install Python, if needed.

***KAlignedoscope*** has minimal package dependicy requirement, all are Python's default (Standard Library) packages. In addition, it requires the `pandas` package, which should be installed upon the installation of *KAlignedoscope*; if it is not, install it via
````
pip install pandas
````

### Installing *KAlignedoscope*

Run
````
pip install kalignedoscope
````
to install the tool. To check if the tool has been successfully installed, run
````
python -m kalignedoscope -h
````
which will prompt the user with the following helper messages:
````bash
FILL THIS PART
````

## Run KAlignedoscope on an example dataset

First, download the example dataset from ``/Data``.

This is the clustering alignment results, generated by *Clumppling*'s alignment of *ADMIXTURE* runs on the Cape Verde dataset (with 399 individuals), that we use to demonstrate the usage of our interactive visualization tool. 
See [the tutorial of *Clummppling*](https://github.com/PopGenClustering/Clumppling) for a description of the dataset, and how *Clumppling* was run on the clustering results. These are exactly the output data of *Clumppling*.

Suppose these data are put under the directoy ``Data``.

Run the following lines in the terminal to initialize the tool:
````
python -m kalignedoscope 
--membership_folder Data/Cape_Verde_Data 
--alignment_file Data/Cape_Verde_Alignment.txt 
````

## Processing outputs from other tools
This tool primarily functions as a visualization and data navigation tool for alignment results, which may be created from running existing packages such as *Clumppling* or *Pong*. For results from other clustering alignmnent programs, the results may need to be processed before the datasets are fed into the tool.

### Notes on Running Directly from *Clummpling*'s Output Directory
We will need three files: ``modes_aligned`` folder, ``alignment_acrossK_avg.txt`` file, and ``ind_labels_grouped.txt`` file. To make the formatting usuable for our tool you will need to first run it through processFromExternal.py (need to make a output folder path for it to put the sorted data into), then addPopulation.py where you need to use the ind_labels_grouped.txt file (which you should first paste into a .CSV file under a column that matches case with "Population") to add another column to all the datasets. Then the data is ready to be used, but you may want to read in your alignment cost file as well, which should be processed through the convertAligned.py function (which just reads it into CSV format). 

### File input formatting 
#### Title 
KAlignedoscope reads each table as an individual structure plot, as such, the user should tuck all their .Q matrices or processed .CSV files into the data folder under **KAlignedoscope**. Due to the particular nature of this tool that relies on detecting particular K modes and M clusters for layout, each file in the folder should be consistently named with information that must be included in the title: **K** = X Clusters and **M** = Y Modes. For example: ````YourName_KXMY.Q````

#### Data Layout
There should be a name column, optional population column, and $K$ amount of columns for the cluster proportions. It should be noted that the number of of $K$ clusters for each file should be matched across file name and number of cluster columns. If the user decides to use the ````processFromExternal.py```` function they will be safe on the formatting, otherwise the user should be sure their columns are named particularly (matching case): **name, Population, Cluster1, Cluster2...** and so on. Sum of clusters for each individual should be 1.  

### Alignment Data
Alignment data is used to render across-K edges in the Network Connections feature. Designed to read directly from Clumppling's results, which users should download the **alignment_acrossK.txt** file by navigating to the output folder in Clumppling's directory after performing a sucessful run of the program. Otherwise, it is important to format files in the following for compatibility with KAlignedoscope. 

For example, this is the top three rows of Cape Verde alignment data from Clumppling's outout. Please be sure to format as **Mode1-Mode2**. 

| Mode1-Mode2 | Cost                  |
|-------------|-----------------------|
| K4M1-K5M1   | 0.0042625183996884055 |
| K4M2-K5M1   | 0.06438957610509989   |
| K4M1-K5M2   | 0.005455565400171093  |


